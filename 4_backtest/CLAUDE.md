# 4_backtest - 백테스트 및 분석 도구

예측 파이프라인 백테스트 (1_firstend → 2_146 → 3_235)

## 실행

```bash
# 백테스트 (6개 일치 여부)
python main.py --backtest --start 900 --end 1000

# 매치 분포 분석 (NEW in v1.01)
python main.py --distribution --start 1195 --end 1204

# why.py 분석
python 4_backtest/why.py
```

## 출력 파일

| 파일 | 설명 |
|------|------|
| result/backtest.csv | 백테스트 결과 (6개 일치 여부) |
| result/match_distribution.csv | 매치 분포 (0~6개 적중 개수/퍼센트) |

## 현재 설정 (main.py)

| 파라미터 | 값 | 설명 |
|----------|-----|------|
| OFFSET_RANGE | ±10 | ord4 오프셋 범위 |
| TOP_N | 15 | ord235 후보 수 |
| 조합수 | ~560만개 | 회차당 |

## 최근 성능 (1195~1204회차)

| 지표 | 값 |
|------|-----|
| 6개 일치 포함 | 7/10회 (70%) |
| 총 조합수 | 5,627만개 |

### 전체 매치 분포

| 매치 | 개수 | 비율 |
|------|------|------|
| 0개 | 2,252만개 | 40.0% |
| 1개 | 2,391만개 | 42.5% |
| 2개 | 851만개 | 15.1% |
| 3개 | 125만개 | 2.2% |
| 4개 | 7.5만개 | 0.1% |
| 5개 | 1,628개 | 0.0% |
| 6개 | 7개 | 0.0% |

## 파이프라인

1. **데이터 로드**: 목표 회차 직전까지만 학습 데이터로 사용
2. **1_firstend**: (ord1, ord6) 쌍 생성 (477개)
3. **2_ord4**: ord4 계산 (공식 A × 0.60 + ±10 오프셋)
4. **3_ord235**: ord2, ord3, ord5 채우기 (top_n=15)
5. **비교**: 당첨번호와 일치 개수 계산

## 점수화 기준 (3_235)

| 요소 | 점수 | 비고 |
|------|------|------|
| seen 빈도 | ×10 | |
| unseen 빈도 | ×2 | |
| 최빈 구간 (seen) | +15 | |
| 최빈 구간 (unseen) | +20 | |
| 핫 비트 | +5 (+8 for ord5) | ord5 강화 |
| 콜드 비트 | -3 (-5 for ord5) | ord5 강화 |
| 최근 3회 | -5 | |
| 소수 | +3 | ord5 제외 |

## 포지션별 최빈 구간

| 포지션 | 최빈 구간 | 적중률 |
|--------|-----------|--------|
| ord2 | 10-19 | 48.3% |
| ord3 | 15-24 | 조정됨 (평균 19.4) |
| ord5 | 30-39 | 54.6% |
| ord6 | 40-45 | 57.8% |

## why.py 분석 도구

단계별 병목 분석:
- 1단계 (firstend): ord1, ord6 적중률
- 2단계 (ord4): offset 범위 적중률
- 3단계 (ord235): top_n별 적중률 비교

```bash
python 4_backtest/why.py
```

## match_distribution.csv 컬럼

| 컬럼 | 설명 |
|------|------|
| round | 회차 |
| winning | 당첨 번호 |
| total_combinations | 총 조합수 |
| match_0~6 | 각 매치 개수별 조합 수 |
| pct_0~6 | 각 매치 개수별 퍼센트 |
| best_match | 최고 일치 개수 |
| best_rank | 최고 일치 조합 순위 |
| best_prediction | 최고 일치 조합 |
